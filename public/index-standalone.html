<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Daily Training Checklist</title>
<style>
  :root { --bg: #0b0c10; --panel: #16181d; --text: #e9eef8; --muted: #9aa4b2; --accent: #7cc4ff; --accent2: #9bffa0; --danger: #ffb2b2; }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
  a { color: var(--accent); text-decoration: none; }
  .container { max-width: 960px; margin: 0 auto; padding: 24px; }
  header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
  h1 { font-size: 24px; margin: 0; letter-spacing: .3px; }
  .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  select, button, input[type="checkbox"] { accent-color: var(--accent); }
  select, button { background: var(--panel); color: var(--text); border: 1px solid #2a2f3a; border-radius: 10px; padding: 8px 12px; }
  button.primary { background: linear-gradient(180deg, #1e88e5, #1565c0); border: none; }
  button:disabled { opacity: .6; }
  .panel { background: var(--panel); border: 1px solid #222833; border-radius: 16px; padding: 16px; margin-top: 16px; }
  .today { display: grid; grid-template-columns: 1fr; gap: 12px; }
  .today-header { display:flex; justify-content: space-between; align-items: center; gap: 12px; }
  .kpis { display:flex; gap: 16px; flex-wrap: wrap; }
  .kpi { background: #111319; border: 1px solid #202635; padding: 8px 12px; border-radius: 12px; font-size: 13px; color: var(--muted); }
  .kpi strong { color: var(--text); }
  .workout-text pre { white-space: pre-wrap; font-family: inherit; margin: 8px 0 0; }
/* checklist styles */
.tasks { display: grid; gap: 12px; }
.section-title { font-weight: 600; margin: 4px 0; }
.task-list { display: grid; gap: 6px; }
.task { display: flex; align-items: flex-start; gap: 8px; }
.task input[type="checkbox"] { margin-top: 2px; }
.chip { display:inline-block; border:1px solid #2a2f3a; border-radius:999px; padding:2px 8px; font-size:12px; color: var(--muted); }
.day .chip { margin-left: 8px; }
  .list { margin-top: 8px; }
  .day { display:flex; align-items: start; gap: 12px; padding: 10px 8px; border-radius: 12px; border: 1px solid #252b37; margin-bottom: 8px; background: #12151c; cursor: pointer; }
  .day.done { opacity: .65; }
  .date { width: 120px; color: var(--muted); font-size: 12px; }
  .title { font-weight: 600; }
  .meta { color: var(--muted); font-size: 12px; }
  .note-ind { font-size: 14px; margin-left: 6px; }
  .grow { flex: 1; }
  .progress { height: 10px; border-radius: 6px; background: #0f1218; border: 1px solid #222836; overflow: hidden; }
  .bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); width: 0%; transition: width .25s ease; }
  .footer { color: var(--muted); font-size: 12px; margin-top: 16px; }
  .notes { display: grid; gap: 8px; }
  .notes textarea { width: 100%; min-height: 96px; resize: vertical; background: #0e1218; color: var(--text); border: 1px solid #222833; border-radius: 12px; padding: 10px 12px; font-family: inherit; }
  .saveStatus { color: var(--muted); font-size: 12px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Daily Training Checklist</h1>
    <div class="controls">
      <label>Week
        <select id="weekSelect"></select>
      </label>
      <button id="todayBtn" class="primary">Jump to Today</button>
      <button id="resetBtn" title="Clear completion for the selected week">Reset Week</button>
    </div>
  </header>

  <div class="panel today">
    <div class="today-header">
      <div>
        <div id="todayTitle" class="title"></div>
        <div id="todayMeta" class="meta"></div>
      </div>
      <label><input type="checkbox" id="todayDone"/> Completed</label>
    </div>
    <div class="kpis">
      <div class="kpi">Phase: <strong id="todayPhase"></strong></div>
      <div class="kpi">Week mileage: <strong id="todayMileage"></strong> mi</div>
      <div class="kpi">Progress: <strong id="progressText"></strong></div>
    </div>
    <section class="tasks">
      <div class="group">
        <div class="section-title">Warm-up</div>
        <div id="listWarmup" class="task-list"></div>
      </div>
      <div class="group">
        <div class="section-title">Workout</div>
        <label class="task"><input type="checkbox" id="workoutChk"/> <span id="workoutText"></span></label>
      </div>
      <div class="group">
        <div class="section-title">Cool-down</div>
        <div id="listCooldown" class="task-list"></div>
      </div>
    </section>
      <div><strong>Warm-up</strong><pre id="todayWarmup"></pre></div>
      <div><strong>Cool-down</strong><pre id="todayCooldown"></pre></div>
    </div>
    <div class="notes">
      <label for="todayNote"><strong>Notes</strong></label>
      <textarea id="todayNote" placeholder="How did it feel? Pace, HR, aches, weather, etc."></textarea>
      <div style="display:flex; align-items:center; gap:8px; justify-content: space-between;">
        <div class="saveStatus" id="saveStatus">Idle</div>
        <button id="clearNoteBtn" title="Clear note for this day">Clear Note</button>
      </div>
    </div>
    <div class="progress"><div class="bar" id="progressBar"></div></div>
  </div>

  <div class="panel">
    <h3 style="margin-top:0">This Week</h3>
    <div id="weekList" class="list"></div>
  </div>

  <div class="footer">Data stored locally on this device with <code>localStorage</code>. You can safely refresh or go offline.</div>
</div>

<!-- Embedded plan data (trimmed for brevity in this view; keep as-is in your file) -->
<script id="workouts" type="application/json">
[]
</script>

<script>
(async function(){
  let data;
  try {
    const res = await fetch('/workouts.json', { cache: 'no-store' });
    if (res.ok) data = await res.json();
  } catch (e) { /* ignore, will fall back */ }
  if (!data) {
    const el = document.getElementById('workouts');
    data = el && el.textContent.trim() ? JSON.parse(el.textContent) : [];
  }
  const weekSelect = document.getElementById('weekSelect');
  const weekList = document.getElementById('weekList');
  const todayBtn = document.getElementById('todayBtn');
  const resetBtn = document.getElementById('resetBtn');

  const todayTitle = document.getElementById('todayTitle');
  const todayMeta = document.getElementById('todayMeta');
  const todayPhase = document.getElementById('todayPhase');
  const todayMileage = document.getElementById('todayMileage');
  const listWarmup = document.getElementById('listWarmup');
  const listCooldown = document.getElementById('listCooldown');
  const workoutChk = document.getElementById('workoutChk');
  const workoutText = document.getElementById('workoutText');
  const todayDone = document.getElementById('todayDone');
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');

  const todayNote = document.getElementById('todayNote');
  const saveStatus = document.getElementById('saveStatus');
  const clearNoteBtn = document.getElementById('clearNoteBtn');

  const byWeek = groupBy(data, x => x.week);
  const weeks = Object.keys(byWeek).map(Number).sort((a,b)=>a-b);

  // populate weeks
  for (const w of weeks) {
    const opt = document.createElement('option');
    opt.value = String(w);
    opt.textContent = `Week ${w}`;
    weekSelect.appendChild(opt);
  }

  // choose initial week: today's week if in plan; else first
  const todayISO = todayLocalISO();
  const todayIdx = data.findIndex(d => d.date === todayISO);
  const initialWeek = todayIdx >= 0 ? data[todayIdx].week : weeks[0];
  weekSelect.value = String(initialWeek);

  renderWeek();
  renderToday(todayIdx >= 0 ? todayIdx : data.findIndex(d=>d.week==initialWeek));

  // events
  weekSelect.addEventListener('change', ()=>{
    renderWeek();
    const firstOfWeek = data.findIndex(d => d.week == Number(weekSelect.value));
    renderToday(firstOfWeek);
  });

  todayBtn.addEventListener('click', ()=>{
    const idx = data.findIndex(d => d.date === todayISO);
    if (idx >= 0) {
      weekSelect.value = String(data[idx].week);
      renderWeek();
      scrollToDay(data[idx].date);
      renderToday(idx);
    } else {
      alert('Today is not inside this plan. Showing the closest week.');
      const closest = closestIndexByDate(data, new Date());
      weekSelect.value = String(data[closest].week);
      renderWeek();
      scrollToDay(data[closest].date);
      renderToday(closest);
    }
  });

  resetBtn.addEventListener('click', ()=>{
    if (!confirm('Clear completion for all days in this week?')) return;
    const w = Number(weekSelect.value);
    for (const d of byWeek[w]) setDone(d.date, false);
    renderWeek();
    updateProgress();
    const current = document.querySelector('.day[data-today]');
    const curDate = current ? current.dataset.date : byWeek[w][0]?.date;
    if (curDate){
      const idx = data.findIndex(d=>d.date===curDate);
      if (idx>=0) renderToday(idx);
    }
  });

  todayDone.addEventListener('change', ()=>{
    if (!currentDay) return;
    setAllDay(currentDay, todayDone.checked);
    // Rebuild lists to reflect the toggle
    renderToday(currentDayIndex);
    updateProgress();
  });
    // update the corresponding row checkbox
    const row = document.querySelector(`.day input[type=checkbox][data-date="${cssEscape(date)}"]`);
    if (row) row.checked = todayDone.checked, row.closest('.day').classList.toggle('done', todayDone.checked);
    updateProgress();
  });

  // Notes save (debounced) + clear
  let noteTimer = null;
  todayNote.addEventListener('input', ()=>{
    setSaveStatus('Savingâ€¦');
    clearTimeout(noteTimer);
    const date = todayNote.dataset.date;
    const val = todayNote.value;
    noteTimer = setTimeout(()=>{
      setNote(date, val.trim());
      setSaveStatus(val.trim() ? 'Saved' : 'Cleared');
      // update indicator on week row
      const meta = document.querySelector(`.day[data-date="${cssEscape(date)}"] .meta`);
      if (meta){
        let ind = meta.querySelector('.note-ind');
        if (val.trim()){
          if (!ind){ ind = document.createElement('span'); ind.className='note-ind'; ind.textContent='ðŸ“'; meta.appendChild(ind); }
        } else if (ind){ ind.remove(); }
      }
    }, 350);
  });

  clearNoteBtn.addEventListener('click', ()=>{
    todayNote.value = '';
    todayNote.dispatchEvent(new Event('input'));
  });

  function renderWeek(){
    weekList.innerHTML = '';
    const w = Number(weekSelect.value);
    for (const d of byWeek[w]) {
      const li = document.createElement('div');
      li.className = 'day';
      li.dataset.date = d.date;

      const date = document.createElement('div');
      date.className = 'date';
      date.textContent = formatDate(d.date);

      const main = document.createElement('div');
      main.className = 'grow';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = d.workout;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${d.day} â€¢ ${d.phase}`;
      if (getNote(d.date)) {
        const ind = document.createElement('span');
        ind.className = 'note-ind';
        ind.textContent = 'ðŸ“';
        meta.appendChild(ind);
      }
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.dataset.date = d.date;
      main.append(title, meta, chip);

      li.append(date, main);
      li.addEventListener('click', ()=>{
        const idx = data.findIndex(x => x.date === d.date);
        renderToday(idx);
        li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });

      weekList.append(li);
      updateWeekRowMeta(d);
    }
    updateProgress();
  });
      checkbox.addEventListener('click', ev => ev.stopPropagation());

      const date = document.createElement('div');
      date.className = 'date';
      date.textContent = formatDate(d.date);

      const main = document.createElement('div');
      main.className = 'grow';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = d.workout;
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${d.day} â€¢ ${d.phase}`;
      if (getNote(d.date)) {
        const ind = document.createElement('span');
        ind.className = 'note-ind';
        ind.textContent = 'ðŸ“';
        meta.appendChild(ind);
      }
      main.append(title, meta);

      li.append(checkbox, date, main);
      li.addEventListener('click', ()=>{
        const idx = data.findIndex(x => x.date === d.date);
        renderToday(idx);
        li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });

      weekList.append(li);
    }
    updateProgress();
  }

  function renderToday(idx){
    currentDayIndex = idx;
    const d = data[idx];
    currentDay = d;
    document.querySelectorAll('.day').forEach(el=>el.removeAttribute('data-today'));
    const row = document.querySelector(`.day[data-date="${cssEscape(d.date)}"]`);
    if (row) row.setAttribute('data-today','true');

    todayTitle.textContent = `${formatDate(d.date)} â€¢ Week ${d.week}`;
    todayMeta.textContent = `${d.day} â€” ${d.phase}`;
    todayPhase.textContent = d.phase;
    todayMileage.textContent = d.weeklyMileage ?? '';

    // Build tasks
    buildTaskList(listWarmup, splitTasks(d.warmup), d.date, 'warm');
    workoutText.textContent = d.workout || 'Workout';
    workoutChk.checked = getSub(d.date, 'workout', 0);
    workoutChk.onchange = () => { setSub(d.date, 'workout', 0, workoutChk.checked); syncTodayCompletion(d); };
    buildTaskList(listCooldown, splitTasks(d.cooldown), d.date, 'cool');

    // Notes
    todayNote.value = getNote(d.date);
    todayNote.dataset.date = d.date;
    setSaveStatus('Idle');

    // Sync completion checkbox
    syncTodayCompletion(d);
  }

  function updateProgress(){
    const w = Number(weekSelect.value);
    const days = byWeek[w] || [];
    let done = 0, total = 0;
    for (const d of days){ const t = getDayTotals(d); done += t.done; total += t.total; }
    const pct = total ? Math.round((done / total) * 100) : 0;
    progressText.textContent = `${done}/${total} (${pct}%)`;
    progressBar.style.width = pct + '%';
  }/${days.length} (${pct}%)`;
    progressBar.style.width = pct + '%';
  }

  // storage helpers
  function key(date){ return 'workoutDone:' + date; }
  function getDone(date){ return localStorage.getItem(key(date)) === '1'; }
  function setDone(date, val){ localStorage.setItem(key(date), val ? '1' : '0'); }
  function noteKey(date){ return 'workoutNote:' + date; }
  function getNote(date){ return localStorage.getItem(noteKey(date)) || ''; }
  function setNote(date, val){ if (!val) localStorage.removeItem(noteKey(date)); else localStorage.setItem(noteKey(date), val); }

  // subtask storage
  function subKey(date, section, idx){ return `sub:${date}:${section}:${idx}`; }
  function getSub(date, section, idx){ return localStorage.getItem(subKey(date, section, idx)) === '1'; }
  function setSub(date, section, idx, val){ localStorage.setItem(subKey(date, section, idx), val ? '1' : '0'); }

  function splitTasks(s){ return (s||'').split(';').map(x=>x.trim()).filter(Boolean); }
  function getDayTotals(d){
    const warm = splitTasks(d.warmup); const cool = splitTasks(d.cooldown);
    const total = warm.length + 1 + cool.length; // +1 for workout
    let done = 0;
    for (let i=0;i<warm.length;i++) if (getSub(d.date,'warm',i)) done++;
    if (getSub(d.date,'workout',0)) done++;
    for (let i=0;i<cool.length;i++) if (getSub(d.date,'cool',i)) done++;
    return { done, total };
  }
  function setAllDay(d, val){
    const warm = splitTasks(d.warmup); const cool = splitTasks(d.cooldown);
    for (let i=0;i<warm.length;i++) setSub(d.date,'warm',i,val);
    setSub(d.date,'workout',0,val);
    for (let i=0;i<cool.length;i++) setSub(d.date,'cool',i,val);
    setDone(d.date, val);
    updateWeekRowMeta(d);
  }
  function buildTaskList(container, items, date, section){
    container.innerHTML='';
    items.forEach((text, idx)=>{
      const label = document.createElement('label');
      label.className='task';
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.checked = getSub(date, section, idx);
      cb.addEventListener('change', ()=>{ setSub(date, section, idx, cb.checked); syncTodayCompletion(currentDay); });
      const span = document.createElement('span');
      span.textContent = text;
      label.append(cb, span);
      container.append(label);
    });
  }
  function syncTodayCompletion(d){
    const t = getDayTotals(d);
    const completed = t.done === t.total && t.total > 0;
    todayDone.checked = completed;
    setDone(d.date, completed);
    updateWeekRowMeta(d);
    updateProgress();
  }
  function updateWeekRowMeta(d){
    const row = document.querySelector(`.day[data-date="${cssEscape(d.date)}"]`);
    if (!row) return;
    const chip = row.querySelector('.chip');
    const t = getDayTotals(d);
    const completed = t.done === t.total && t.total>0;
    row.classList.toggle('done', completed);
    if (chip){ chip.textContent = completed ? 'âœ… Completed' : `${t.done}/${t.total}`; }
  }

  function setSaveStatus(s){ saveStatus.textContent = s; }(date, val){ if (!val) localStorage.removeItem(noteKey(date)); else localStorage.setItem(noteKey(date), val); }

  // utils
  function formatDate(iso){
    const d = new Date(iso+'T00:00:00');
    return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'});
  }
  function groupBy(arr, f){
    return arr.reduce((acc, x)=>{ const k=f(x); (acc[k]=acc[k]||[]).push(x); return acc; },{});
  }
  let currentDay = null, currentDayIndex = 0;
  function closestIndexByDate(arr, target){
    const t = target.getTime();
    let bestIdx = 0, bestDiff = Infinity;
    for (let i=0;i<arr.length;i++){ const diff = Math.abs(new Date(arr[i].date).getTime() - t); if (diff < bestDiff) bestDiff = diff, bestIdx = i; }
    return bestIdx;
  }
  function scrollToDay(date){
    const row = document.querySelector(`.day[data-date="${cssEscape(date)}"]`);
    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  function cssEscape(s){ return s.replace(/["\\]/g, "\\$&"); }
  function todayLocalISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
})();
</script>
</body>
</html>
